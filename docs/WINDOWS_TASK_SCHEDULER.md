# Windows 计划任务配置指南

## 目标
在电脑启动时自动同步竞彩数据（后台运行，无窗口）

---

## 方法 1：通过任务计划程序图形界面（推荐）

### 步骤 1：打开任务计划程序

1. 按 `Win + R` 打开运行对话框
2. 输入 `taskschd.msc` 并回车
3. 或者：开始菜单 → Windows 管理工具 → 任务计划程序

### 步骤 2：创建基本任务

1. 右侧点击 **"创建基本任务"**
2. 名称：`MatchStats 竞彩启动同步`
3. 描述：`电脑启动时自动同步竞彩数据到 Supabase`
4. 点击 **"下一步"**

### 步骤 3：设置触发器

1. 选择 **"当计算机启动时"**
2. 点击 **"下一步"**

### 步骤 4：设置操作

1. 选择 **"启动程序"**
2. 点击 **"下一步"**

### 步骤 5：配置程序

**程序或脚本**：
```
E:\CursorData\MatchStats\scripts\sporttery_startup_sync.bat
```

**起始于（可选）**：
```
E:\CursorData\MatchStats
```

点击 **"下一步"**

### 步骤 6：完成

1. 检查设置
2. 勾选 **"当单击完成时，打开此任务属性的对话框"**
3. 点击 **"完成"**

### 步骤 7：高级设置（重要）

在打开的属性对话框中：

**常规** 选项卡：
- ✅ 选择 **"不管用户是否登录都要运行"**
- ✅ 取消勾选 **"不存储密码"**
- ✅ 配置为：**Windows Vista 或更高版本**

**触发器** 选项卡：
- 编辑触发器
- ✅ 勾选 **"延迟任务"**：**2 分钟**
  - 原因：等待系统完全启动和网络连接建立

**条件** 选项卡：
- ✅ 取消勾选 **"只有在计算机使用交流电源时才启动此任务"**（如果是笔记本电脑）
- ✅ 取消勾选 **"如果计算机改用电池模式则停止"**

**设置** 选项卡：
- ✅ 勾选 **"如果任务失败，按以下频率重新启动"**
  - 间隔：**5 分钟**
  - 重试次数：**3 次**
- ✅ 勾选 **"按需运行任务"**

点击 **"确定"**，输入密码（如果需要）

---

## 方法 2：通过命令行快速创建

**以管理员身份运行命令提示符**，执行：

```cmd
schtasks /create /tn "MatchStats 竞彩启动同步" /tr "E:\CursorData\MatchStats\scripts\sporttery_startup_sync.bat" /sc onstart /delay 0002:00 /ru "SYSTEM" /rl highest /f
```

**参数说明**：
- `/tn` - 任务名称
- `/tr` - 要运行的脚本
- `/sc onstart` - 计算机启动时触发
- `/delay 0002:00` - 延迟 2 分钟
- `/ru "SYSTEM"` - 以系统账户运行
- `/rl highest` - 最高权限
- `/f` - 强制创建（如果已存在则覆盖）

---

## 验证任务

### 方法 1：手动运行测试

1. 在任务计划程序中找到 **"MatchStats 竞彩启动同步"**
2. 右键 → **"运行"**
3. 等待 10 秒钟
4. 访问 https://kmatch-stats.vercel.app/ 查看竞彩数据

### 方法 2：查看历史记录

1. 右键任务 → **"属性"**
2. 切换到 **"历史记录"** 选项卡
3. 查看最近的运行记录

### 方法 3：重启电脑测试

重启电脑，等待 2-3 分钟后检查数据。

---

## 查看日志

同步日志保存在：
```
E:\CursorData\MatchStats\logs\matchstats.log
```

查看最后几行：
```cmd
tail -20 E:\CursorData\MatchStats\logs\matchstats.log
```

或在 PowerShell 中：
```powershell
Get-Content E:\CursorData\MatchStats\logs\matchstats.log -Tail 20
```

---

## 故障排除

### 问题 1：任务没有运行

**检查**：
1. 任务计划程序 → 任务 → 历史记录
2. 查看错误信息

**常见原因**：
- 路径不正确
- 权限不足
- Python 环境变量问题

**解决**：
- 确认脚本路径：`E:\CursorData\MatchStats\scripts\sporttery_startup_sync.bat`
- 以管理员身份创建任务

### 问题 2：运行但数据未更新

**检查**：
1. 查看日志文件
2. 手动运行脚本测试

**手动测试**：
```cmd
cd E:\CursorData\MatchStats
venv\Scripts\python.exe scripts\sync_sporttery_now.py
```

### 问题 3：弹出命令行窗口

**原因**：使用了 `python.exe` 而不是 `pythonw.exe`

**解决**：确保批处理文件使用 `pythonw.exe`（无窗口版本）

---

## 卸载任务

如果不再需要此任务：

**方法 1：图形界面**
- 任务计划程序 → 右键任务 → **"删除"**

**方法 2：命令行**
```cmd
schtasks /delete /tn "MatchStats 竞彩启动同步" /f
```

---

## 工作原理

```
电脑启动
    ↓
等待 2 分钟（系统初始化）
    ↓
运行 sporttery_startup_sync.bat（后台，无窗口）
    ↓
调用竞彩 API
    ↓
保存到 Supabase 云端数据库
    ↓
完成（完全无感知）
```

---

## 时间估算

- 启动延迟：2 分钟
- 同步时间：5-10 秒
- 总耗时：约 2 分钟

**对系统性能影响**：几乎为零（仅后台运行几秒钟）

---

## 建议

1. **最佳运行时间**：电脑启动后 2-3 分钟
2. **备用方案**：如果使用频率高，可以每天启动时同步
3. **监控方式**：偶尔访问网站查看数据是否更新

---

配置完成后，你完全不需要做任何操作，每次电脑启动时数据会自动更新！
