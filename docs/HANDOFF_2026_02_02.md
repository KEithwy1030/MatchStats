# 项目交接文档 - MatchStats (v0.1.0)

**更新时间**: 2026-02-02
**交接对象**: 接手 Agent / 开发人员

---

## 1. 项目概况

**MatchStats** 是一个基于 Python (FastAPI) + Vue.js 的足球数据平台，主要功能是提供英超、西甲等五大联赛的**积分榜、射手榜、赛程比分**，并支持**竞彩数据**分析。

*   **在线地址**: [https://kmatch-stats.vercel.app/](https://kmatch-stats.vercel.app/)
*   **核心功能**: 数据自动同步 (Scheduler)、中文化展示、API 接口服务。
*   **技术栈**:
    *   **后端**: FastAPI, APScheduler, Supabase (PostgreSQL), Pydantic
    *   **前端**: Vue.js (CDN形式), TailwindCSS
    *   **数据源**: Football-Data.org (API), 竞彩官网

---

## 2. 关键数据流与修复记录 (重要)

在此次任务中，我们解决了一系列核心数据问题。接手者**必须**了解以下逻辑变更：

### 2.1 射手榜与助攻榜 (Scorers & Assists)
*   **现状**:
    *   API (`/competitions/{code}/scorers`) 并不总是返回助攻数据。
    *   **Haaland** 等球星数据准确，但许多球员 `assists` 字段为 `NULL`。
*   **处理逻辑**:
    *   **强制置零**: 后端入库时（`FDRepository.save_scorer`），强制把 `NULL` 转换为 `0`。
    *   **目的**: 防止数据库排序时 `NULL` 值排在数字前面，导致榜单乱序（如 Mateta 0助攻 排在 Haaland 5助攻 前面）。
*   **潜在风险**: 助攻榜数据对于非核心球员可能不准确（仅供参考）。

### 2.2 赛季年份 (Season ID)
*   **变更**: 之前积分榜使用“年份”（如 2024）作为 `season` 字段，通过 `startDate` 解析。
*   **现在**: 统一改为使用 Football-Data 官方的 **Season ID** (如 2403)。
*   **一致性**: 
    *   `fd_matches` (比赛表) -> 使用 ID (2403)
    *   `fd_standings` (积分榜) -> 使用 ID (2403)
    *   `fd_scorers` (射手榜) -> 使用 ID (2403)
*   **影响**: 任何涉及历史赛季查询的 SQL，都应使用 ID 进行关联，而非年份。

### 2.3 中文翻译 (Translations)
*   **机制**: 
    *   球队基础信息表 `fd_teams` 包含 `name_cn` 字段。
    *   前端展示数据（比赛、积分、射手）时，后端会通过 `team_id` 自动关联 `fd_teams` 表，取出中文名一并返回。
*   **数据源**:
    *   已运行脚本 `scripts/update_translations_cn.py` 将约 150+ 支球队的中文名写入了 Supabase。

---

## 3. 核心文件指引

| 文件路径 | 作用 | 最近修改点 |
| :--- | :--- | :--- |
| `app/scheduler/__init__.py` | **调度中心** | 1. 修复了积分榜只存总榜(TOTAL)的逻辑;<br>2. 修复了 Season ID 的提取逻辑。 |
| `app/repositories/__init__.py` | **数据库操作** | 1. `get_scorers` 增加了中文名关联;<br>2. `save_scorer` 增加了 NULL 转 0 逻辑。 |
| `app/scrapers/__init__.py` | **爬虫核心** | 优化了 `get_scorers` 和 `get_standings` 的返回值，使其包含 Season Info。 |
| `app/static/index.html` | **前端入口** | 适配了中文名字段 (`team_name_cn`) 的显示。 |
| `scripts/fix_all_seasons.py` | **修复脚本** | **一次性脚本**，用于回填历史数据的 Season ID，接手者无需重复运行。 |

---

## 4. 常用运维指令

### 4.1 手动触发数据同步
如果发现线上数据滞后，可在本地终端运行：
```bash
# 强制同步射手榜 (调试模式)
$env:PYTHONPATH="."; python scripts/debug_sync_scorers.py
```

### 4.2 检查数据完整性
```bash
# 检查 API 是否返回了特定字段 (如助攻)
$env:PYTHONPATH="."; python scripts/verify_api_fields.py
```

---

## 5. 遗留问题与待办

1.  **助攻数据源**: 当前免费版 API 助攻数据质量一般，未来如有预算建议升级或更换 Sportmonks 等更专业数据源。
2.  **前端优化**: 目前是单页 HTML，如果功能继续扩充，建议迁移到 **Nuxt.js** 或 **Vite** 构建工程化项目。
3.  **定时任务**: Vercel Serverless 环境下 `APScheduler` 定时任务可能不稳定（受冷启动影响），建议配置 **Vercel Cron** 或外部 Cron Job 触发 `/api/v1/sync` 接口。

---

**End of Handoff**
