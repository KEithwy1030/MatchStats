<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatchStats 赛事数据中心</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="/static/style.css">
    <!-- Scripts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>

<body>
    <div id="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <i class="ph-fill ph-soccer-ball logo-icon"></i>
                <span>MatchStats</span>
            </div>

            <nav class="nav-menu">
                <div class="nav-item" :class="{ active: activeSource === 'fd' }" @click="activeSource = 'fd'">
                    <i class="ph ph-globe-hemisphere-west"></i>
                    <span>欧洲赛事数据</span>
                </div>
                <div class="nav-item" :class="{ active: activeSource === 'sporttery' }"
                    @click="activeSource = 'sporttery'">
                    <i class="ph ph-flag-banner"></i>
                    <span>中国竞彩数据</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="sys-status">
                    <span class="status-dot"></span> 系统运行正常<br>
                    <span style="opacity:0.5; font-size:11px; margin-top:4px; display:block;">最后同步: {{
                        formatDateTime(stats.last_sync) }}</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-title">
                    <h2>{{ activeSource === 'fd' ? '欧洲主流联赛 (Football-Data)' : '中国体育彩票 (竞彩官网)' }} 数据概览</h2>
                </div>
                <div class="header-actions">
                    <button class="btn" @click="refreshAll" :disabled="loading">
                        <i class="ph ph-arrows-clockwise" :class="{ 'ph-spin': loading }"></i>
                        刷新数据
                    </button>
                    <!-- Status Filter -->
                    <div class="tab-group" style="margin:0; height:32px;">
                        <button class="tab-btn" :class="{ active: matchFilter === 'ALL' }"
                            @click="matchFilter = 'ALL'">全部</button>
                        <button class="tab-btn" :class="{ active: matchFilter === 'LIVE' }"
                            @click="matchFilter = 'LIVE'">进行中</button>
                        <button class="tab-btn" :class="{ active: matchFilter === 'SCHEDULED' }"
                            @click="matchFilter = 'SCHEDULED'">未开始</button>
                        <button class="tab-btn" :class="{ active: matchFilter === 'FINISHED' }"
                            @click="matchFilter = 'FINISHED'">已结束</button>
                    </div>
                </div>
            </header>

            <div class="content-scroll">

                <!-- Stat Cards -->
                <div class="dashboard-grid" style="margin-bottom: 24px;">
                    <div class="stat-card card">
                        <div class="stat-value">{{ stats.fd_matches }}</div>
                        <div class="stat-sub">欧洲赛事总库存</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-value">{{ stats.sporttery_matches }}</div>
                        <div class="stat-sub">竞彩官网记录数</div>
                    </div>
                    <div class="stat-card card" style="border-color: var(--primary);">
                        <div class="stat-value">{{ matches.length }}</div>
                        <div class="stat-sub">当前视图场次</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-value" style="color:var(--accent);">活跃</div>
                        <div class="stat-sub">数据库状态</div>
                    </div>
                </div>

                <div class="dashboard-grid">

                    <!-- Matches List -->
                    <div class="match-section card">
                        <div class="card-title">
                            <span>比赛日程表</span>

                            <!-- League Selector for FD -->
                            <div v-if="activeSource === 'fd'" class="tab-group" style="margin:0;">
                                <button class="tab-btn" :class="{ active: activeLeague === 'ALL' }"
                                    @click="activeLeague = 'ALL'">全部</button>
                                <button v-for="l in leagues" class="tab-btn"
                                    :class="{ active: activeLeague === l.code }" @click="activeLeague = l.code">
                                    {{ l.name }}
                                </button>
                            </div>
                        </div>

                        <div class="matches-list">
                            <div v-if="loading && matches.length === 0"
                                style="padding:20px; text-align:center; color:var(--text-dim);">
                                正在加载比赛数据...
                            </div>
                            <div v-else-if="matches.length === 0"
                                style="padding:20px; text-align:center; color:var(--text-dim);">
                                当前筛选条件下暂无比赛数据
                            </div>

                            <div v-for="m in matches" :key="m.id || m.match_code" class="match-item"
                                @click="openMatchDetails(m)"
                                :style="{ cursor: activeSource === 'fd' ? 'pointer' : 'default' }">
                                <!-- FD Structure -->
                                <template v-if="activeSource === 'fd'">
                                    <div class="m-time">
                                        <div v-if="(m.status === 'LIVE' || m.status === 'IN_PLAY' || m.status === 'PAUSED')"
                                            class="live-indicator"></div>
                                        <div>{{ formatTime(m.match_date) }}</div>
                                        <div style="font-size:10px; opacity:0.6;">{{ formatDate(m.match_date) }}</div>
                                    </div>
                                    <div class="m-teams">
                                        <div class="m-team home">
                                            <span>{{ m.home_team_name_cn || m.home_team_name }}</span>
                                            <img v-if="m.home_team_logo" :src="m.home_team_logo" class="team-logo"
                                                alt="">
                                        </div>
                                        <div class="m-score"
                                            :class="{ 'live': m.status === 'LIVE' || m.status === 'IN_PLAY' || m.status === 'PAUSED' }">
                                            <span v-if="m.status !== 'SCHEDULED' && m.status !== 'TIMED'">
                                                {{ m.home_score }} - {{ m.away_score }}
                                            </span>
                                            <span v-else>VS</span>
                                        </div>
                                        <div class="m-team away">
                                            <img v-if="m.away_team_logo" :src="m.away_team_logo" class="team-logo"
                                                alt="">
                                            <span>{{ m.away_team_name_cn || m.away_team_name }}</span>
                                        </div>
                                    </div>
                                    <div class="m-status">
                                        <span class="badge" :class="{
                                                'live': m.status === 'LIVE' || m.status === 'IN_PLAY' || m.status === 'PAUSED',
                                                'finished': m.status === 'FINISHED',
                                                'scheduled': m.status === 'SCHEDULED' || m.status === 'TIMED'
                                            }">
                                            {{ getStatusText(m.status) }}
                                        </span>
                                    </div>
                                </template>

                                <!-- Sporttery Structure -->
                                <template v-else>
                                    <div class="m-time">
                                        <div>{{ formatTime(m.match_time) }}</div>
                                        <div style="font-size:10px; opacity:0.6;">{{ formatDate(m.match_time) }}</div>
                                    </div>
                                    <div class="m-teams">
                                        <div class="m-team home">
                                            <span>{{ m.home_team }}</span>
                                        </div>
                                        <div class="m-score">
                                            <span>{{ m.actual_score || 'VS' }}</span>
                                        </div>
                                        <div class="m-team away">
                                            <span>{{ m.away_team }}</span>
                                        </div>
                                    </div>
                                    <div class="m-status">
                                        <span class="badge" :class="{'finished': m.match_status === 'Final'}">{{
                                            m.league }}</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="side-panel" style="display:flex; flex-direction:column; gap:24px;">

                        <!-- Standings / Scorers (Only FD) -->
                        <div class="card" v-if="activeSource === 'fd'" style="flex:1;">
                            <div class="card-title" style="margin-bottom:10px;">
                                <span>{{ activeTab === 'standings' ? '积分榜' : (activeTab === 'scorers' ? '射手榜' : '助攻榜')
                                    }} ({{ leagues.find(l => l.code ===
                                    activeLeague)?.name }})</span>
                                <div class="tab-group" style="margin:0;">
                                    <button class="tab-btn" :class="{ active: activeTab === 'standings' }"
                                        @click="activeTab = 'standings'">积分</button>
                                    <button class="tab-btn" :class="{ active: activeTab === 'scorers' }"
                                        @click="activeTab = 'scorers'">射手</button>
                                    <button class="tab-btn" :class="{ active: activeTab === 'assists' }"
                                        @click="activeTab = 'assists'">助攻</button>
                                </div>
                            </div>

                            <div style="overflow-y:auto; max-height:400px;">
                                <table v-if="activeTab === 'standings'">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>球队</th>
                                            <th>场</th>
                                            <th>分</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="s in standings" :key="s.team_id">
                                            <td>
                                                <div class="rank-num"
                                                    :style="{ background: s.position <= 4 ? 'var(--primary)' : '' }">
                                                    {{ s.position }}
                                                </div>
                                            </td>
                                            <td>{{ s.team_name_cn || s.team_name }}</td>
                                            <td>{{ s.played_games }}</td>
                                            <td style="font-weight:700;">{{ s.points }}</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <table v-else>
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>球员</th>
                                            <th>球队</th>
                                            <th>{{ activeTab === 'assists' ? '助 / 球' : '球 / 助' }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(s, index) in scorers" :key="index">
                                            <td style="color:var(--text-dim);">{{ index + 1 }}</td>
                                            <td style="font-weight:500;">{{ s.player_name }}</td>
                                            <td style="font-size:12px; color:var(--text-muted);">{{ s.team_name_cn ||
                                                s.team_name }}</td>
                                            <td style="font-weight:700; color:var(--accent);">
                                                <template v-if="activeTab === 'assists'">
                                                    {{ s.assists || 0 }} / <span
                                                        style="font-weight:400; color:var(--text-muted); font-size:12px;">{{
                                                        s.goals }}</span>
                                                </template>
                                                <template v-else>
                                                    {{ s.goals }} / <span
                                                        style="font-weight:400; color:var(--text-muted); font-size:12px;">{{
                                                        s.assists || 0 }}</span>
                                                </template>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div v-if="activeTab === 'scorers' && scorers.length === 0"
                                    style="padding:20px; text-align:center; color:var(--text-dim); font-size:12px;">
                                    暂无射手榜数据
                                </div>
                            </div>
                        </div>

                        <!-- System Logs -->
                        <div class="card" style="flex:1; max-height:400px;">
                            <div class="card-title">系统同步日志</div>
                            <div class="logs-container">
                                <div v-for="log in logs" class="log-entry">
                                    <div>
                                        <span
                                            :class="{'log-status success': log.status === 'success', 'log-status error': log.status !== 'success'}">
                                            [{{ log.status === 'success' ? '正常' : '异常' }}]
                                        </span>
                                        {{ log.source }} / {{ log.task_type }}
                                    </div>
                                    <div style="opacity:0.5;">{{ log.started_at ? formatTime(log.started_at) : '' }}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- Match Details Modal -->
                    <div class="modal-overlay" :class="{ active: showModal }" @click.self="closeModal">
                        <div class="modal-content" v-if="activeMatchDetail">
                            <div class="modal-header">
                                <div style="font-weight:600; font-size:16px;">
                                    <i class="ph-fill ph-soccer-ball"
                                        style="color:var(--primary); margin-right:8px;"></i>
                                    比赛详情
                                    <span style="font-weight:400; opacity:0.5; font-size:12px; margin-left:10px;">{{
                                        formatDateTime(activeMatchDetail.match_date) }}</span>
                                </div>
                                <button class="modal-close" @click="closeModal"><i class="ph ph-x"></i></button>
                            </div>

                            <!-- Scoreboard -->
                            <div class="modal-scoreboard">
                                <div class="score-team">
                                    <h3>{{ activeMatchDetail.home_team_name }}</h3>
                                    <span class="match-meta-badge"
                                        v-if="activeMatchDetail.lineup_home.length > 0">已公布首发</span>
                                </div>
                                <div style="text-align:center;">
                                    <div class="score-main">
                                        <span
                                            v-if="activeMatchDetail.status !== 'SCHEDULED' && activeMatchDetail.status !== 'TIMED'">
                                            {{ activeMatchDetail.home_score }} - {{ activeMatchDetail.away_score }}
                                        </span>
                                        <span v-else>VS</span>
                                    </div>
                                    <div style="margin-top:10px;">
                                        <span class="badge" :class="{
                                'live': activeMatchDetail.status === 'LIVE' || activeMatchDetail.status === 'IN_PLAY' || activeMatchDetail.status === 'PAUSED',
                                'finished': activeMatchDetail.status === 'FINISHED',
                                'scheduled': activeMatchDetail.status === 'SCHEDULED' || activeMatchDetail.status === 'TIMED'
                            }">{{ getStatusText(activeMatchDetail.status) }}</span>
                                    </div>
                                </div>
                                <div class="score-team">
                                    <h3>{{ activeMatchDetail.away_team_name }}</h3>
                                    <span class="match-meta-badge"
                                        v-if="activeMatchDetail.lineup_away.length > 0">已公布首发</span>
                                </div>
                            </div>

                            <div class="modal-body">
                                <!-- Timeline / Goals -->
                                <div class="timeline-section"
                                    v-if="activeMatchDetail.goals && activeMatchDetail.goals.length > 0">
                                    <h4 style="margin-top:0;">进球事件</h4>
                                    <div v-for="g in activeMatchDetail.goals" :key="g.minute + g.player_name"
                                        class="goal-event">
                                        <div class="goal-time">{{ formatGoalTime(g) }}</div>
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <i class="ph-fill ph-soccer-ball" style="color:var(--accent);"></i>
                                            <span
                                                :style="{ fontWeight: 'bold', color: g.home_away === 'home' ? 'var(--primary)' : 'var(--warning)' }">
                                                {{ g.player_name }}
                                            </span>
                                            <span style="opacity:0.6; font-size:12px;">({{ g.team_name }})</span>
                                            <span style="font-size:12px; color:var(--text-dim);">{{
                                                getGoalTypeBadge(g.type) }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div style="text-align:center; padding:40px; color:var(--text-dim);"
                                    v-if="(!activeMatchDetail.goals || activeMatchDetail.goals.length === 0) && (activeMatchDetail.status === 'FINISHED' || activeMatchDetail.status === 'IN_PLAY')">
                                    暂无进球记录
                                </div>

                                <!-- Lineups -->
                                <div class="details-grid" v-if="activeMatchDetail.lineup_home.length > 0">
                                    <!-- Home -->
                                    <div class="lineup-col">
                                        <h4>{{ activeMatchDetail.home_team_name }} 首发 ({{
                                            activeMatchDetail.home_coach_name || '主教练未知' }})</h4>
                                        <div v-for="p in activeMatchDetail.lineup_home" class="player-row">
                                            <span class="player-num">{{ p.shirtNumber }}</span>
                                            <span class="player-name">{{ p.name }}</span>
                                            <span class="player-pos">{{ p.position }}</span>
                                        </div>

                                        <h4 style="margin-top:30px;">替补</h4>
                                        <div v-for="p in activeMatchDetail.bench_home" class="player-row">
                                            <span class="player-num">{{ p.shirtNumber }}</span>
                                            <span class="player-name">{{ p.name }}</span>
                                            <span class="player-pos">{{ p.position }}</span>
                                        </div>
                                    </div>

                                    <!-- Away -->
                                    <div class="lineup-col">
                                        <h4>{{ activeMatchDetail.away_team_name }} 首发 ({{
                                            activeMatchDetail.away_coach_name || '主教练未知' }})</h4>
                                        <div v-for="p in activeMatchDetail.lineup_away" class="player-row">
                                            <span class="player-num">{{ p.shirtNumber }}</span>
                                            <span class="player-name">{{ p.name }}</span>
                                            <span class="player-pos">{{ p.position }}</span>
                                        </div>

                                        <h4 style="margin-top:30px;">替补</h4>
                                        <div v-for="p in activeMatchDetail.bench_away" class="player-row">
                                            <span class="player-num">{{ p.shirtNumber }}</span>
                                            <span class="player-name">{{ p.name }}</span>
                                            <span class="player-pos">{{ p.position }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div v-else-if="activeMatchDetail.status === 'SCHEDULED' || activeMatchDetail.status === 'TIMED'"
                                    style="text-align:center; padding:40px; color:var(--text-dim);">
                                    <i class="ph ph-users" style="font-size:32px; margin-bottom:10px;"></i><br>
                                    首发名单尚未公布
                                </div>

                                <!-- JSON Toggle -->
                                <div class="raw-json-toggle">
                                    <button class="btn" @click="showRawJson = !showRawJson"
                                        style="width:100%; justify-content:center; opacity:0.7;">
                                        <i class="ph ph-code"></i> {{ showRawJson ? '收起' : '查看' }} API 原始数据
                                    </button>
                                    <div class="raw-json" v-if="showRawJson">
                                        {{ JSON.stringify(activeMatchDetail, null, 2) }}
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/app.js"></script>
</body>

</html>